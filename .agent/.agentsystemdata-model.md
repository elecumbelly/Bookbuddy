# Core Data Model - Bookbuddy

## Current State (Version 0.4)

### Book Entity
```
Book
├── id: UUID (Primary Key)
├── title: String? (Optional)
├── author: String? (Optional)
├── isbn: String? (Optional, ISBN-10 or ISBN-13)
├── publishedDate: Date? (Optional)
├── pageCount: Int32 (Default: 0)
├── currentPage: Int32 (Default: 0)
├── dateAdded: Date? (Optional)
├── coverImageData: Data? (Optional, JPEG at 70% quality)
├── bookDescription: String? (Optional)
├── status: String? (Optional: "to-read", "reading", "completed")
└── pagePhotos: [PagePhoto] (One-to-many relationship)
```

**Computed Properties:**
- `displayTitle: String` - Returns title or "Unknown Title"
- `displayAuthor: String` - Returns author or "Unknown Author"
- `readingProgress: Double` - Calculated as currentPage / pageCount
- `readingProgressPercentage: Int` - Progress as 0-100 integer
- `statusEnum: BookStatus` - Converts status string to enum
- `pagePhotosArray: [PagePhoto]` - Sorted array of page photos (newest first)

**BookStatus Enum:**
```swift
enum BookStatus: String, CaseIterable {
    case toRead = "to-read"
    case reading = "reading"
    case completed = "completed"
}
```

### PagePhoto Entity (Added in v0.4)
```
PagePhoto
├── id: UUID? (Optional)
├── imageData: Data? (Optional, JPEG at 70% quality)
├── dateAdded: Date? (Optional)
└── book: Book? (Many-to-one relationship)
```

**Computed Properties:**
- `displayDate: String` - Formatted date string (medium date + short time)

**Relationship Configuration:**
- Book.pagePhotos ←→ PagePhoto.book (One-to-many bidirectional)
- Cascade delete: Deleting a Book deletes all associated PagePhotos

## Data Validation

### ISBN Validation
- **ISBN-10**: Modulus 11 check digit algorithm
- **ISBN-13**: Modulus 10 check digit with 1-3 weighting
- Real-time validation with visual feedback (ISBNValidator utility)

### Page Number Validation
- currentPage must be >= 0 and <= pageCount
- Validated before saving progress updates

### Image Compression
- All images compressed to JPEG at 70% quality
- Reduces typical images from ~500KB to ~50-100KB
- Applied to both coverImageData and PagePhoto.imageData

## Core Data Configuration

### Thread Safety
- **Main Context**: `viewContext` for all UI operations
- **Main Actor**: All view models run on @MainActor
- **Background Operations**: Not currently implemented (future consideration)

### Merge Policy
- Uses default merge policy (last writer wins)
- `automaticallyMergesChangesFromParent = true` on viewContext

### Migration Strategy
- **Current**: No migrations needed (v0.4 is base model)
- **Future**: Plan lightweight migrations for attribute additions
- **Complex Migrations**: Will require custom migration mapping

### Error Handling
- Persistence.swift implements graceful fallback to in-memory store
- Silent failures logged with print statements (⚠️ prefix)
- UI displays user-facing error alerts via ErrorAlertModifier

## API Integration

### Open Library API
- **Endpoint**: `https://openlibrary.org/api/books`
- **Format**: JSON with ISBN lookup
- **Fields Used**: title, authors, number_of_pages, notes/excerpts, publish_date, cover images
- **Network**: URLSession with async/await
- **Error Handling**: Custom BookLookupError enum

## Data Flow

### Adding a Book
1. User scans barcode or enters ISBN
2. ISBN validated locally (checksum algorithm)
3. API lookup fetches metadata (async)
4. User reviews/edits data
5. Book entity created and saved to Core Data
6. UI updates via @FetchRequest

### Updating Progress
1. User opens UpdateProgressView
2. Voice or manual input for page number
3. Validation (page <= pageCount)
4. Status auto-updated (0 → to-read, >0 → reading, ≥pageCount → completed)
5. Core Data save + dismiss
6. Parent view refreshes via viewContext.refresh()

### Capturing Page Photos
1. User taps "Capture Page" button
2. Camera captures photo via UIImagePickerController
3. Optional: Markup with PencilKit (pen, pencil, highlighter, eraser)
4. Optional: Share via UIActivityViewController
5. Save: Create PagePhoto entity linked to Book
6. Image compressed to JPEG 70% before saving
7. UI refreshes photo grid via book.pagePhotosArray

## Performance Considerations

### Fetch Requests
- Books sorted by dateAdded (descending) for recency
- No batch limits (acceptable for personal library scale)
- FetchedResults provides automatic change tracking

### Image Storage
- Binary data stored in Core Data with external storage enabled
- Compression reduces database size significantly
- Consider file system storage for future scaling (>1000 books)

### Memory Management
- Views use `let book: Book` where possible (not @ObservedObject)
- Only list views need @FetchRequest observation
- Images loaded on-demand from Data

## Future Considerations

### Potential Enhancements
- **Genre/Tag System**: Many-to-many relationship for categorization
- **Reading Sessions**: Track reading time and sessions
- **Notes & Highlights**: Text annotations per book
- **Book Lists/Collections**: Custom groupings beyond status
- **Sync**: CloudKit integration for multi-device sync
- **Export**: CSV/PDF export of library data

### Performance Optimization Ideas
- Implement pagination for large libraries (>500 books)
- Background context for bulk imports
- Thumbnail generation for cover images
- Search indexing with NSPredicate optimization

### Data Model Evolution
- Plan for lightweight migrations (adding optional attributes)
- Document breaking changes requiring custom migrations
- Maintain backward compatibility where possible
