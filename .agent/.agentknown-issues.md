# Known Issues & Pitfalls - Bookbuddy

This document captures critical lessons learned from production bugs and regressions. **Read this before refactoring any core functionality.**

---

## üö® CRITICAL: Gesture Recognition Blocking

### Issue Summary
**UIImpactFeedbackGenerator blocks the main thread** on devices without haptic engine support, causing iOS gesture recognition system to timeout with `"System gesture gate timed out"` errors. This breaks **ALL** gesture recognition app-wide, not just the element that triggered it.

### Symptoms
- Button taps don't respond at all
- Document scanner crop handles become non-functional
- Console shows: `"<0x102631400> Gesture: System gesture gate timed out."`
- Other UI elements (Cancel button, etc.) may still work while specific gestures fail

### Root Cause
`UIImpactFeedbackGenerator.impactOccurred()` performs synchronous work on the main thread. On devices without haptic hardware (or with haptic disabled), this operation hangs, blocking gesture event processing.

### Affected Code
- **UpdateProgressView.swift** - `handleMicrophoneTap()` function
- Any button/gesture handler that might add haptic feedback in the future

### Solution
**DO NOT use UIImpactFeedbackGenerator anywhere in this codebase.**

If haptic feedback is absolutely necessary in the future:
1. Check device capability first with `UIDevice.current.supportsHaptics` (custom extension needed)
2. Dispatch to background queue
3. Add timeout safeguards
4. Test on devices without haptic support (iPad models, older iPhones)

### Version History
- **v0.5.2** - Bug introduced by adding haptic feedback to mic button
- **v0.5.3** - Bug fixed by removing haptic feedback entirely

### Code Location
See inline comments in:
- `Bookbuddy/UpdateProgressView.swift:248-255` (handleMicrophoneTap)

---

## ‚ö†Ô∏è IMPORTANT: Audio Session Management

### Issue Summary
Improper audio session lifecycle management blocks camera/document scanner when speech recognition has been used:
- Audio session stays active in `.record` mode after speech recognition
- Camera cannot access audio (blocked by active record session)
- Document scanner gesture recognition fails (corner handles non-responsive)
- `FigCaptureSourceRemote` errors in console

### Root Cause
**Original v0.5.2 bug:** Aggressive `setActive(false)` without proper options
**Original v0.5.3 "fix":** Removed deactivation entirely ‚Üí audio session stays active forever
**Actual v0.5.4 fix:** Properly deactivate with `.notifyOthersOnDeactivation` option + cleanup on view disappear

When speech recognition activates audio session in `.record` mode, it must be deactivated when done to free the audio hardware for camera use. Not deactivating leaves the session locked.

### Affected Code
- **SpeechRecognitionManager.swift** - `stopListening()` function
- **UpdateProgressView.swift** - `.onDisappear` handler

### Solution
**ALWAYS deactivate audio session in stopListening() with proper options:**
```swift
try AVAudioSession.sharedInstance().setActive(false, options: .notifyOthersOnDeactivation)
```

**ALWAYS stop speech recognition when UpdateProgressView disappears:**
```swift
.onDisappear {
    if speechManager.isListening {
        speechManager.stopListening()
    }
}
```

The `.notifyOthersOnDeactivation` option allows other audio sessions (like camera) to resume.

### Version History
- **v0.5.2** - Bug introduced by aggressive audio session cleanup without options
- **v0.5.3** - Incorrect fix: removed audio session deactivation (left session active)
- **v0.5.4** - Proper fix: deactivate with correct options + cleanup on view disappear

### Code Location
- `Bookbuddy/SpeechRecognitionManager.swift:118-139` (stopListening with proper deactivation)
- `Bookbuddy/UpdateProgressView.swift:210-218` (onDisappear cleanup)

---

## üìã User Workflow Requirements

### Speech Recognition Auto-Start (REQUIRED)

**User Intent:** Hands-free operation is the PRIMARY use case, not secondary.

The microphone button is **NOT** the primary interaction method. It's a fallback for when speech recognition gets it wrong.

**Correct Behavior:**
1. User opens Update Progress view
2. Mic auto-starts immediately (if authorized)
3. User speaks page number
4. Mic auto-stops after recognition
5. Button is only used to manually stop/restart if recognition fails

**DO NOT REMOVE auto-start functionality** thinking it improves UX or responsiveness.

### Version History
- **v0.5.2** - Bug introduced by removing auto-start (over-optimization)
- **v0.5.3** - Bug fixed by restoring auto-start behavior

### Code Location
See inline comments in:
- `Bookbuddy/UpdateProgressView.swift:189-198` (.task block)

---

## üõ°Ô∏è Protection Strategies

### 1. Inline Code Comments
All critical sections have **‚ö†Ô∏è CRITICAL** or **‚ö†Ô∏è IMPORTANT** comments explaining WHY code is the way it is and what NOT to do.

### 2. This Document
Reference `.agent/.agentknown-issues.md` in inline comments to provide full context.

### 3. Version Control
Git commit messages document the full regression cycle (introduction ‚Üí discovery ‚Üí fix).

### 4. Testing Protocol
Before refactoring speech recognition or camera features:
1. Test on physical device (not simulator)
2. Test with speech recognition auto-start
3. Test mic button stop/restart functionality
4. Test document scanner crop handles
5. Verify no gesture timeout errors in console

---

## üìö Related Documentation

- **Architecture:** `.agent/.agentsystemdata-model.md`
- **Development Principles:** `.agent/.agentmindset.md`
- **Technical Overview:** `CLAUDE.md`

---

## üîÑ Maintenance

**When to update this document:**
- Any production bug that causes silent failures
- Any regression introduced by refactoring
- Any "seems like a good idea but breaks something" patterns
- Any iOS API quirks that aren't obvious

**Format:**
- Issue summary (what breaks)
- Symptoms (how to recognize it)
- Root cause (why it breaks)
- Solution (what NOT to do)
- Version history (when it happened)
- Code location (where to look)

---

*Last Updated: October 29, 2025 (v0.5.3)*
